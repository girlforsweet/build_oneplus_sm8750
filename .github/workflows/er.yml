name: Build_oneplus_sm8750
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        description: "ËØ∑ÈÄâÊã©Ë¶ÅÁºñËØëÁöÑÊú∫ÂûãÔºö"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_13'
      keep_original_settings:
        description: "‰øùÊåÅÂéüÂÜÖÊ†∏ÂêçÁß∞ÂèäÊûÑÂª∫Êó∂Èó¥"
        required: false
        default: false
        type: boolean
      custom_kernel_suffix:
        description: "Ëá™ÂÆö‰πâÂÜÖÊ†∏ÂêéÁºÄ"
        required: false
        default: ''
      custom_kernel_time:
        description: "Ëá™ÂÆö‰πâÊûÑÂª∫Êó∂Èó¥"
        required: false
        default: ''
      enable_feature_y:
        description: "ÂêØÁî®lz4kd"
        required: false
        default: true
        type: boolean
      enable_feature_z:
        description: "Ê∑ªÂä†È£éÈ©∞Ë∞ÉÂ∫¶"
        required: false
        default: true
        type: boolean
      enable_feature_b:
        description: "ÁΩëÁªúË∞ÉÂ∫¶"
        required: false
        type: choice
        options:
          - 'FQ_CODEL'
          - 'BBR'
        default: 'FQ_CODEL'
      KPM:
        description: "ÂêØÁî®KPM"
        type: boolean
        required: true
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache_${{ github.event.inputs.REPO_MANIFEST }}
      CCACHE_MAXSIZE: 8G
    steps:
      - uses: actions/checkout@v4
      - name: ÂàùÂßãÂåñÂ§á‰ªΩÁõÆÂΩï
        run: |
          mkdir -p kernel_backups/{lz4,config}
          echo "BACKUP_DIR=$GITHUB_WORKSPACE/kernel_backups" >> $GITHUB_ENV
      - name: ËÆæÁΩÆÊú∫ÂûãÂèÇÊï∞
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_13)      echo "REPO_MANIFEST=JiuGeFaCai_oneplus_13_v"      >> $GITHUB_ENV; echo "DEVICES_NAME=oneplus_13" >> $GITHUB_ENV ;;
            oneplus_ace5_pro)echo "REPO_MANIFEST=JiuGeFaCai_oneplus_ace5_pro_v" >> $GITHUB_ENV; echo "DEVICES_NAME=oneplus_ace5_pro" >> $GITHUB_ENV ;;
            *)               echo "REPO_MANIFEST=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV; echo "DEVICES_NAME=${{ github.event.inputs.REPO_MANIFEST }}" >> $GITHUB_ENV ;;
          esac
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_13|oneplus_ace5_pro)   echo 'DEFAULT_SUFFIX=-android15-8-g4dc61d72e02f-abogki415959920-4k' >> $GITHUB_ENV ;;
            realme_GT7pro_Speed)           echo 'DEFAULT_SUFFIX=-android15-8-g013ec21bba94-abogki383916444-4k' >> $GITHUB_ENV ;;
            realme_GT7)                    echo 'DEFAULT_SUFFIX=-android15-8-g06c41a4a6e98-abogki395793266-4k' >> $GITHUB_ENV ;;
            realme_GT7pro)                 echo 'DEFAULT_SUFFIX=-android15-8-gc6f5283046c6-ab12364222-4k' >> $GITHUB_ENV ;;
            oneplus_13t)                   echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV ;;
            oneplus_pad_2_pro)             echo 'DEFAULT_SUFFIX=-android15-8-g7b1f455c7143-ab13591283-4k' >> $GITHUB_ENV ;;
            oneplus_ace5_ultra)            echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV ;;
          esac
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ]; then
            TIME="${{ github.event.inputs.custom_kernel_time }}"
            [ -z "$TIME" ] && TIME="$(date -u +'%a %b %d %H:%M:%S UTC %Y')"
            echo "KERNEL_TIME=$TIME" >> $GITHUB_ENV
          else
            case "${{ env.DEVICES_NAME }}" in
              oneplus_13|oneplus_ace5_pro) echo 'KERNEL_TIME=Mon May 12 09:09:59 UTC 2025' >> $GITHUB_ENV ;;
              realme_GT7pro_Speed)         echo 'KERNEL_TIME=Tue Dec 17 23:36:49 UTC 2024' >> $GITHUB_ENV ;;
              realme_GT7)                  echo 'KERNEL_TIME=Mon Jan 20 03:24:58 UTC 2025' >> $GITHUB_ENV ;;
              realme_GT7pro)               echo 'KERNEL_TIME=Fri Sep 13 02:08:57 UTC 2024' >> $GITHUB_ENV ;;
              oneplus_13t)                 echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV ;;
              oneplus_pad_2_pro)           echo 'KERNEL_TIME=Tue Jun  3 03:22:33 UTC 2025' >> $GITHUB_ENV ;;
              oneplus_ace5_ultra)          echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV ;;
            esac
          fi
      - name: GitÈÖçÁΩÆ
        run: |
          git config --global user.name "FateYin1"
          git config --global user.email "1244243922@qq.com"
      - name: ÂÆâË£Ö‰æùËµñ
        run: |
          sudo apt update -qq
          sudo apt install -yq python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev rsync unzip
      - name: ÁºìÂ≠òccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref }}-${{ github.event.inputs.REPO_MANIFEST }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.event.inputs.REPO_MANIFEST }}-
            ccache-${{ runner.os }}-
      - name: ÂàùÂßãÂåñccache
        run: ccache -M 8G
      - name: ÂÆâË£Örepo
        run: |
          curl -o repo https://storage.googleapis.com/git-repo-downloads/repo
          chmod +x repo
          sudo mv repo /usr/local/bin/
      - name: ÂêåÊ≠•Ê∫êÁ†Å
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${{ env.REPO_MANIFEST }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags
          rm -f kernel_platform/common/android/abi_gki_protected_exports_* kernel_platform/msm-kernel/android/abi_gki_protected_exports_*
      - name: ÂÆâË£ÖSukiSU Ultra
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh | bash -s susfs-main
          cd KernelSU
          KSU_VERSION=$(( $(git rev-list --count main || echo 13000) + 10700 ))
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          curl -LSs "${GITHUB_WORKSPACE}/.github/workflows/Bin/setup.bin" -o setup.bin
          chmod +x setup.bin
          ./setup.bin
      - name: ÊõøÊç¢Ê†áËØÜ
        run: |
          cd kernel_workspace/kernel_platform
          find . -type f -exec sed -i 's/TG@qdykernel/üå∏/g' {} +
      - name: ÈÖçÁΩÆSUSFS
        run: |
          cd kernel_workspace
          git clone --depth=1 -b gki-android15-6.6 https://gitlab.com/simonpunk/susfs4ksu.git
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git
          cd kernel_platform/common
          cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch .
          cp -r ../../susfs4ksu/kernel_patches/fs/* fs/
          cp -r ../../susfs4ksu/kernel_patches/include/linux/* include/linux/
          cp -r ../../SukiSU_patch/other/zram/lz4k/include/linux/* include/linux/
          cp -r ../../SukiSU_patch/other/zram/lz4k/lib/* lib/
          cp -r ../../SukiSU_patch/other/zram/lz4k/crypto/* crypto/
          cp -r ../../SukiSU_patch/other/zram/lz4k_oplus lib/
          if [[ "${{ env.DEVICES_NAME }}" == "realme_GT7pro_Speed" || "${{ env.DEVICES_NAME }}" == "realme_GT7pro" ]]; then
            sed -i 's/-32,12 +32,38/-32,11 +32,37/g' 50_add_susfs_in_gki-android15-6.6.patch
            sed -i '/#include <trace\/hooks\/fs.h>/d' 50_add_susfs_in_gki-android15-6.6.patch
          fi
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch || true
          cp ../../SukiSU_patch/hooks/syscall_hooks.patch .
          patch -p1 -F 3 < syscall_hooks.patch || true
      - name: Â∫îÁî®lz4kd
        if: ${{ github.event.inputs.enable_feature_y }}
        run: |
          cd kernel_workspace/kernel_platform/common
          cp ../../SukiSU_patch/other/zram/zram_patch/6.6/lz4kd.patch .
          patch -p1 -F 3 < lz4kd.patch || true
      - name: HMBirdË°•‰∏Å
        run: |
          cp "${GITHUB_WORKSPACE}/hmbird_patch.c" /tmp/
          cd kernel_workspace/kernel_platform/common/drivers
          cp /tmp/hmbird_patch.c .
          grep -q "hmbird_patch.o" Makefile || echo "obj-y += hmbird_patch.o" >> Makefile
      - name: ÈÖçÁΩÆdefconfig
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" -o main.bin
          chmod +x main.bin
          ./main.bin "setup_gki_config" "${{ github.event.inputs.enable_feature_b }}"
          rm main.bin
          echo "CONFIG_CRYPTO_LZ4K=y" >> common/arch/arm64/configs/gki_defconfig
          [[ ${{ github.event.inputs.enable_feature_y }} == true ]] && echo "CONFIG_CRYPTO_LZ4KD=y" >> common/arch/arm64/configs/gki_defconfig
          sudo sed -i '/check_defconfig/d' common/build.config.gki
          git -C common add -A
          git -C common commit -m "BUILD Kernel" || true
      - name: È£éÈ©∞Ë∞ÉÂ∫¶ÔºàÈõ∂ÂÜ≤Á™ÅÁâàÔºâ
        if: ${{ github.event.inputs.enable_feature_z }}
        run: |
          cd kernel_workspace/kernel_platform/common/kernel
          git clone --depth=1 https://github.com/sched-ext/scx sched_ext
          cp -r sched_ext/sched/* sched/
          rm -rf sched_ext
          echo 'obj-y += ext/' >> sched/Makefile
          cat <<'EOF' >> sched/Kconfig
          menu "Sched_ext schedulers"
          source "kernel/sched/ext/Kconfig"
          endmenu
          EOF
          echo "CONFIG_SCHED_CLASS_EXT=y" >> ../arch/arm64/configs/gki_defconfig
          echo "CONFIG_SCHED_EXT=y" >> ../arch/arm64/configs/gki_defconfig
      - name: ÂÜÖÊ†∏ÂêçÁß∞
        run: |
          cd kernel_workspace/kernel_platform
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ]; then
            SUFFIX="${{ github.event.inputs.custom_kernel_suffix }}"
            [ -z "$SUFFIX" ] && SUFFIX="${{ env.DEFAULT_SUFFIX }}"
            ESC=$(printf '%s' "$SUFFIX" | sed 's/[&/]/\\&/g')
            sudo sed -i "s/-4k/$ESC/g" common/arch/arm64/configs/gki_defconfig
          fi
          sed -i 's/${scm_version}//g' common/scripts/setlocalversion
      - name: ÂêØÁî®KPM
        if: ${{ github.event.inputs.KPM == 'true' }}
        run: |
          echo "CONFIG_KPM=y" >> kernel_workspace/kernel_platform/common/arch/arm64/configs/gki_defconfig
      - name: ÁºñËØëÂÜÖÊ†∏
        env:
          PATH: /usr/lib/ccache:$PATH
        run: |
          export KBUILD_BUILD_TIMESTAMP="${{ env.KERNEL_TIME }}"
          cd kernel_workspace/kernel_platform/common
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out Image
      - name: KPMË°•‰∏Å
        if: ${{ github.event.inputs.KPM == 'true' }}
        run: |
          cd kernel_workspace/kernel_platform/common/out/arch/arm64/boot
          curl -L https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux -o p
          chmod +x p
          ./p
          mv oImage Image
      - name: ÊâìÂåÖAnyKernel3
        run: |
          git clone --depth=1 https://github.com/FateYin1/AnyKernel3
          cp kernel_workspace/kernel_platform/common/out/arch/arm64/boot/Image AnyKernel3/
      - name: ‰∏ãËΩΩÁÆ°ÁêÜÂô®
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          run_id=$(gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/workflows/build-manager.yml/runs?branch=main&status=success&per_page=1" --jq '.workflow_runs[0].id')
          [ -n "$run_id" ] && gh api "repos/SukiSU-Ultra/SukiSU-Ultra/actions/runs/$run_id/artifacts" | jq -r '.artifacts[]|select(.name=="manager")|.archive_download_url' | head -1 | xargs -I{} curl -H "Authorization: token $GITHUB_TOKEN" -L {} -o mgr.zip
          [ -f mgr.zip ] && unzip -j mgr.zip "*.apk" -d AnyKernel3/
      - name: ‰∏ä‰º†Âà∑ÂåÖ
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU_${{ env.KSUVER }}_${{ env.DEVICES_NAME }}${{ github.event.inputs.KPM == 'true' && '_KPM' || '' }}${{ github.event.inputs.enable_feature_z == 'true' && '_FengChi' || '' }}
          path: AnyKernel3/*
