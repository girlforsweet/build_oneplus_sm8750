name: Build_oneplus_sm8750
on:
  workflow_dispatch:
    inputs:
      REPO_MANIFEST:
        required: true
        type: choice
        options:
          - oneplus_13
          - oneplus_ace5_pro
          - oneplus_13t
          - oneplus_pad_2_pro
          - oneplus_ace5_ultra
          - realme_GT7
          - realme_GT7pro
          - realme_GT7pro_Speed
        default: oneplus_13
      keep_original_settings:
        type: boolean
        default: false
      custom_kernel_suffix:
        default: ''
      custom_kernel_time:
        default: ''
      enable_feature_y:
        description: lz4kd
        type: boolean
        default: true
      enable_feature_z:
        description: 风驰调度
        type: boolean
        default: true
      enable_feature_b:
        type: choice
        options:
          - FQ_CODEL
          - BBR
        default: FQ_CODEL
      KPM:
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache_${{ github.event.inputs.REPO_MANIFEST }}
      CCACHE_MAXSIZE: 8G
    steps:
      - uses: actions/checkout@v4

      - name: 备份目录
        run: |
          mkdir -p "$GITHUB_WORKSPACE/backups/config"
          mkdir -p "$GITHUB_WORKSPACE/backups/lz4"
          echo "BACKUP=$GITHUB_WORKSPACE/backups" >> $GITHUB_ENV

      - name: 机型参数
        run: |
          case "${{ github.event.inputs.REPO_MANIFEST }}" in
            oneplus_13)       M=JiuGeFaCai_oneplus_13_v;       N=oneplus_13 ;;
            oneplus_ace5_pro) M=JiuGeFaCai_oneplus_ace5_pro_v; N=oneplus_ace5_pro ;;
            *)                M=${{ github.event.inputs.REPO_MANIFEST }}; N=${{ github.event.inputs.REPO_MANIFEST }} ;;
          esac
          echo "MANIFEST=$M" >> $GITHUB_ENV
          echo "DEVICE=$N" >> $GITHUB_ENV

          case "$N" in
            oneplus_13|oneplus_ace5_pro) S=-android15-8-g4dc61d72e02f-abogki415959920-4k ;;
            realme_GT7pro_Speed)         S=-android15-8-g013ec21bba94-abogki383916444-4k ;;
            realme_GT7)                  S=-android15-8-g06c41a4a6e98-abogki395793266-4k ;;
            realme_GT7pro)               S=-android15-8-gc6f5283046c6-ab12364222-4k ;;
            oneplus_13t)                 S=-android15-8-gd43086512890-abogki423825152-4k ;;
            oneplus_pad_2_pro)           S=-android15-8-g7b1f455c7143-ab13591283-4k ;;
            oneplus_ace5_ultra)          S=-android15-8-g29d86c5fc9dd-abogki428889875-4k ;;
          esac
          echo "SUFFIX=$S" >> $GITHUB_ENV

          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ]; then
            T="${{ github.event.inputs.custom_kernel_time }}"
            [ -z "$T" ] && T="$(date -u '+%a %b %d %H:%M:%S UTC %Y')"
            echo "TIME=$T" >> $GITHUB_ENV
          else
            case "$N" in
              oneplus_13|oneplus_ace5_pro) echo "TIME=Mon May 12 09:09:59 UTC 2025" >> $GITHUB_ENV ;;
              realme_GT7pro_Speed)         echo "TIME=Tue Dec 17 23:36:49 UTC 2024" >> $GITHUB_ENV ;;
              realme_GT7)                  echo "TIME=Mon Jan 20 03:24:58 UTC 2025" >> $GITHUB_ENV ;;
              realme_GT7pro)               echo "TIME=Fri Sep 13 02:08:57 UTC 2024" >> $GITHUB_ENV ;;
              oneplus_13t)                 echo "TIME=Tue Jun 10 12:12:23 UTC 2025" >> $GITHUB_ENV ;;
              oneplus_pad_2_pro)           echo "TIME=Tue Jun  3 03:22:33 UTC 2025" >> $GITHUB_ENV ;;
              oneplus_ace5_ultra)          echo "TIME=Tue Jul  1 19:48:18 UTC 2025" >> $GITHUB_ENV ;;
            esac
          fi

      - name: 依赖
        run: |
          sudo apt update -qq
          sudo apt install -yq git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool rsync unzip

      - name: ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref }}-${{ github.event.inputs.REPO_MANIFEST }}
          restore-keys: ccache-${{ runner.os }}-${{ github.event.inputs.REPO_MANIFEST }}-

      - name: repo
        run: |
          curl -o repo https://storage.googleapis.com/git-repo-downloads/repo
          chmod +x repo
          sudo mv repo /usr/local/bin/

      - name: 源码
        run: |
          mkdir ws && cd ws
          repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${{ env.MANIFEST }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags

      - name: SukiSU
        run: |
          cd ws/kernel_platform
          curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh | bash -s susfs-main
          cd KernelSU
          V=$(( $(git rev-list --count main 2>/dev/null || echo 13000) + 10700 ))
          echo "KSUVER=$V" >> $GITHUB_ENV
          curl -LSs "$GITHUB_WORKSPACE/.github/workflows/Bin/setup.bin" -o setup.bin
          chmod +x setup.bin
          ./setup.bin

      - name: SUSFS
        run: |
          cd ws
          git clone --depth=1 -b gki-android15-6.6 https://gitlab.com/simonpunk/susfs4ksu.git
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git
          cd kernel_platform/common
          cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch .
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch || true
          cp ../../SukiSU_patch/hooks/syscall_hooks.patch .
          patch -p1 -F 3 < syscall_hooks.patch || true

      - name: lz4kd
        if: ${{ github.event.inputs.enable_feature_y }}
        run: |
          cd ws/kernel_platform/common
          cp ../../SukiSU_patch/other/zram/zram_patch/6.6/lz4kd.patch .
          patch -p1 -F 3 < lz4kd.patch || true

      - name: HMBird
        run: |
          cp "$GITHUB_WORKSPACE/hmbird_patch.c" /tmp/
          cd ws/kernel_platform/common/drivers
          cp /tmp/hmbird_patch.c .
          grep -q "hmbird_patch.o" Makefile || echo "obj-y += hmbird_patch.o" >> Makefile

      - name: defconfig
        run: |
          cd ws/kernel_platform
          curl -LSs "$GITHUB_WORKSPACE/.github/workflows/Bin/main.bin" -o m
          chmod +x m
          ./m "setup_gki_config" "${{ github.event.inputs.enable_feature_b }}"
          rm m
          echo "CONFIG_CRYPTO_LZ4K=y" >> common/arch/arm64/configs/gki_defconfig
          [ "${{ github.event.inputs.enable_feature_y }}" = "true" ] && echo "CONFIG_CRYPTO_LZ4KD=y" >> common/arch/arm64/configs/gki_defconfig
          sudo sed -i '/check_defconfig/d' common/build.config.gki

      - name: 风驰
        if: ${{ github.event.inputs.enable_feature_z }}
        run: |
          cd ws/kernel_platform/common/kernel
          git clone --depth=1 https://github.com/sched-ext/scx
          cp -r scx/sched/* sched/
          rm -rf scx
          echo 'obj-y += ext/' >> sched/Makefile
          cat <<EOF >> sched/Kconfig
          menu "Sched_ext schedulers"
          source "kernel/sched/ext/Kconfig"
          endmenu
          EOF
          echo "CONFIG_SCHED_CLASS_EXT=y" >> ../arch/arm64/configs/gki_defconfig
          echo "CONFIG_SCHED_EXT=y" >> ../arch/arm64/configs/gki_defconfig

      - name: 内核名
        run: |
          cd ws/kernel_platform
          if [ "${{ github.event.inputs.keep_original_settings }}" = "false" ]; then
            X="${{ github.event.inputs.custom_kernel_suffix }}"
            [ -z "$X" ] && X="${{ env.SUFFIX }}"
            X=$(printf '%s' "$X" | sed 's/[&/]/\\&/g')
            sudo sed -i "s/-4k/$X/g" common/arch/arm64/configs/gki_defconfig
          fi
          sed -i 's/${scm_version}//g' common/scripts/setlocalversion

      - name: KPM
        if: ${{ github.event.inputs.KPM }}
        run: echo "CONFIG_KPM=y" >> ws/kernel_platform/common/arch/arm64/configs/gki_defconfig

      - name: 编译
        env:
          PATH: /usr/lib/ccache:$PATH
        run: |
          export KBUILD_BUILD_TIMESTAMP="${{ env.TIME }}"
          cd ws/kernel_platform/common
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 O=out Image

      - name: KPM补丁
        if: ${{ github.event.inputs.KPM }}
        run: |
          cd ws/kernel_platform/common/out/arch/arm64/boot
          curl -L https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux -o p
          chmod +x p
          ./p
          mv oImage Image

      - name: AnyKernel3
        run: |
          git clone --depth=1 https://github.com/FateYin1/AnyKernel3
          cp ws/kernel_platform/common/out/arch/arm64/boot/Image AnyKernel3/

      - name: 上传
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU_${{ env.KSUVER }}_${{ env.DEVICE }}${{ github.event.inputs.KPM && '_KPM' || '' }}${{ github.event.inputs.enable_feature_z && '_FengChi' || '' }}
          path: AnyKernel3/*
